import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { BasePrmTabComponentService } from '../base-prm-tab-component.service';
import { PrmTabs } from '../../prm-panel/prm-tabs';
import { Tab } from '../../../tab';
import {
  PersonWithReducedMobilityService,
  PlatformOverview,
  ReadTrafficPointElementVersion,
  TrafficPointElementsService,
} from '../../../../api';
import { PlatformOverviewRow } from './platform-overview-row';
import { TableColumn } from '../../../../core/components/table/table-column';
import { TableFilter } from '../../../../core/components/table-filter/config/table-filter';
import { Pages } from '../../../pages';
import { TableService } from '../../../../core/components/table/table.service';
import { TablePagination } from '../../../../core/components/table/table-pagination';
import { mergeMap } from 'rxjs';
import { SloidHelper } from '../../../../core/util/sloidHelper';
import { tap } from 'rxjs/operators';
import { TableContentPaginationAndSorting } from '../../../../core/components/table/table-content-pagination-and-sorting';

@Component({
  selector: 'app-platform',
  templateUrl: './platform-table.component.html',
})
export class PlatformTableComponent extends BasePrmTabComponentService implements OnInit {
  platforms: PlatformOverviewRow[] = [];
  totalCount = 0;
  trafficPointElements: ReadTrafficPointElementVersion[] = [];

  tableColumns: TableColumn<PlatformOverviewRow>[] = [
    { headerTitle: 'SEPODI.TRAFFIC_POINT_ELEMENTS.DESIGNATION', value: 'designation' },
    { headerTitle: 'SEPODI.SERVICE_POINTS.SLOID', value: 'sloid' },
    {
      headerTitle: 'SEPODI.TRAFFIC_POINT_ELEMENTS.DESIGNATION_OPERATIONAL',
      value: 'designationOperational',
    },
    { headerTitle: 'COMMON.VALID_FROM', value: 'validFrom', formatAsDate: true },
    { headerTitle: 'COMMON.VALID_TO', value: 'validTo', formatAsDate: true },
    {
      headerTitle: 'PRM.PLATFORMS.RECORDING_STATUS',
      value: 'completion',
      translate: { withPrefix: 'PRM.PLATFORMS.RECORDINGSTATUS.' },
    },
  ];
  tableFilterConfig!: TableFilter<unknown>[][];

  constructor(
    readonly router: Router,
    private route: ActivatedRoute,
    private tableService: TableService,
    private personWithReducedMobilityService: PersonWithReducedMobilityService,
    private trafficPointElementsService: TrafficPointElementsService,
  ) {
    super(router);
  }

  ngOnInit(): void {
    this.showCurrentTab(this.route.parent!.snapshot.data);

    this.tableFilterConfig = this.tableService.initializeFilterConfig({}, Pages.PLATFORMS);
  }

  getTab(): Tab {
    return PrmTabs.PLATFORM;
  }

  rowClicked(clickedRow: PlatformOverviewRow) {
    this.router.navigate([clickedRow.sloid], { relativeTo: this.route }).then();
  }

  getOverview(pagination: TablePagination) {
    const sloid = this.route.parent!.snapshot.params.stopPointSloid!;
    this.trafficPointElementsService
      .getPlatformsOfServicePoint(SloidHelper.servicePointSloidToNumber(sloid))
      .pipe(
        tap((sepodiPlatforms) => {
          this.trafficPointElements = sepodiPlatforms.objects!;
          this.totalCount = sepodiPlatforms.totalCount!;
        }),
        mergeMap(() => this.personWithReducedMobilityService.getPlatformOverview(sloid)),
      )
      .subscribe((platforms) => {
        const mergedPlatformInfos = this.mergeTrafficPointAndPlatformDataForOverview(platforms);
        this.platforms = TableContentPaginationAndSorting.pageAndSort(
          mergedPlatformInfos,
          pagination,
          'designation',
        );
        this.totalCount = mergedPlatformInfos.length;
      });
  }

  mergeTrafficPointAndPlatformDataForOverview(prmPlatformOverview: PlatformOverview[]) {
    const mergedOverview: PlatformOverviewRow[] = [];
    this.trafficPointElements.forEach((trafficPointElementInSePoDi) => {
      const correspondingPrmPlatform = prmPlatformOverview.find(
        (i) => i.sloid === trafficPointElementInSePoDi.sloid!,
      );
      mergedOverview.push({
        designation: trafficPointElementInSePoDi.designation,
        designationOperational: trafficPointElementInSePoDi.designationOperational,
        sloid: trafficPointElementInSePoDi.sloid!,
        validFrom: correspondingPrmPlatform?.validFrom,
        validTo: correspondingPrmPlatform?.validTo,
        completion: correspondingPrmPlatform?.recordingStatus || 'NOT_STARTED',
      });
    });
    return mergedOverview;
  }

  navigateToTrafficPointElements(){
    const number = this.route.parent!.snapshot.data.servicePoints[0].number.number;
    this.router.navigate([
      Pages.SEPODI.path,
      Pages.SERVICE_POINTS.path,
      number,
      Pages.TRAFFIC_POINT_ELEMENTS_PLATFORM.path
    ]);
  }
}
