{
  "$schema": "https://clew-resources.sbb-cloud.net/tekton-schema.json",
  "productName": "atlas",
  "advancedBuildSettings": {
    "buildWorkspaceSize": "25Gi",
    "buildCacheSize": "10Gi",
    "taggingWorkspaceSize": "2Gi",
    "pipelineTimeout": "1h30m0s"
  },
  "builder": {
    "java": "21",
    "node": "20"
  },
  "gradle": {
    "artifactoryMavenRepo": "atlas.mvn",
    "buildTaskName": "esta-gradle-build-extra-large"
  },
  "docker": [
    {
      "dockerFile": "line-directory/docker/Dockerfile",
      "imageName": "line-directory",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "business-organisation-directory/docker/Dockerfile",
      "imageName": "business-organisation-directory",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "service-point-directory/docker/Dockerfile",
      "imageName": "service-point-directory",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "prm-directory/docker/Dockerfile",
      "imageName": "prm-directory",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "import-service-point/docker/Dockerfile",
      "imageName": "import-service-point",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "export-service-point/docker/Dockerfile",
      "imageName": "export-service-point",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "imageName": "mail",
      "dockerFile": "mail/docker/Dockerfile",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "imageName": "scheduling",
      "dockerFile": "scheduling/docker/Dockerfile",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "artifactoryDockerRepo": "atlas.docker",
      "dockerFile": "gateway/docker/Dockerfile",
      "imageName": "gateway"
    },
    {
      "dockerFile": "user-administration/docker/Dockerfile",
      "imageName": "user-administration",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "artifactoryDockerRepo": "atlas.docker",
      "dockerFile": "workflow/docker/Dockerfile",
      "imageName": "workflow"
    },
    {
      "artifactoryDockerRepo": "atlas.docker",
      "dockerFile": "location/docker/Dockerfile",
      "imageName": "location"
    },
    {
      "dockerFile": "api-auth-gateway/docker/Dockerfile",
      "imageName": "api-auth-gateway",
      "artifactoryDockerRepo": "atlas.docker"
    },
    {
      "dockerFile": "frontend/docker/Dockerfile",
      "imageName": "atlas-frontend",
      "artifactoryDockerRepo": "atlas.docker",
      "contextDir": "frontend"
    }
  ],
  "pipelines": [
    {
      "name": "continuous",
      "triggerType": [
        "GITEVENT"
      ],
      "branchNamePrefixes": [
        "feature"
      ],
      "build": {
        "testcontainers": {
          "enabled": true
        },
        "buildDockerImage": false,
        "sonarScan": {
          "enabled": true
        },
        "additionalBuildParams": "--parallel",
        "failOnQualityGateFailure": true
      },
      "tasks": [
        {
          "name": "generate-apim-config",
          "taskRef": "esta-gradle-build-extra-large",
          "params": {
            "TASKS": ":apim-configuration:generateSpec",
            "ARTIFACTORY_SECRET": "esta-tekton-basicauth-docker",
            "BUILDER_JAVA_VERSION": "21",
            "BUILDER_KOTLIN_VERSION": "1.7",
            "BUILDER_NODE_VERSION": "20",
            "JDK_BUILDERIMAGE": "esta.docker.bin.sbb.ch/esta/esta-tekton-pipeline-java-builderimage:2.9.1",
            "SONAR_HOST_URL": "https://codequality.sbb.ch",
            "SONAR_LOGIN_SECRET": "esta-tekton-sonar-api-key"
          },
          "runAfter": "gradle-build",
          "runBefore": "gradle-sonarscan"
        }
      ]
    },
    {
      "name": "manualRelease",
      "branchNamePrefixes": [
        "master"
      ],
      "tasks": [
        {
          "name": "generate-apim-config",
          "taskRef": "esta-gradle-build-extra-large",
          "params": {
            "TASKS": ":apim-configuration:generateSpec",
            "ARTIFACTORY_SECRET": "esta-tekton-basicauth-docker",
            "BUILDER_JAVA_VERSION": "21",
            "BUILDER_KOTLIN_VERSION": "1.7",
            "BUILDER_NODE_VERSION": "20",
            "JDK_BUILDERIMAGE": "esta.docker.bin.sbb.ch/esta/esta-tekton-pipeline-java-builderimage:2.9.1",
            "SONAR_HOST_URL": "https://codequality.sbb.ch",
            "SONAR_LOGIN_SECRET": "esta-tekton-sonar-api-key"
          },
          "runAfter": "gradle-build",
          "runBefore": "gradle-sonarscan"
        },
        {
          "name": "atlas-start-deploy-dev-pipeline",
          "taskRef": "atlas-start-pipeline",
          "params": {
            "GIT_PROJECT": "KI_ATLAS",
            "GIT_REPOSITORY": "atlas-deploy-dev",
            "GIT_REVISION": "refs/heads/master",
            "PIPELINE_CONFIG_NAME": "continuous",
            "PIPELINE_PARAMETERS_JSON": "{\"VERSION_TO_DEPLOY\":\"${VERSION_TAG}\"}"
          },
          "runAfter": "gradle-deploy"
        },
        {
          "name": "atlas-start-deploy-test-pipeline",
          "taskRef": "atlas-start-pipeline",
          "params": {
            "GIT_PROJECT": "KI_ATLAS",
            "GIT_REPOSITORY": "atlas-deploy-test",
            "GIT_REVISION": "refs/heads/master",
            "PIPELINE_CONFIG_NAME": "continuous",
            "PIPELINE_PARAMETERS_JSON": "{\"VERSION_TO_DEPLOY\":\"${VERSION_TAG}\"}"
          },
          "runAfter": "gradle-deploy"
        }
      ],
      "triggerType": [
        "USER"
      ],
      "build": {
        "testcontainers": {
          "enabled": true
        },
        "buildDockerImage": true,
        "sonarScan": {
          "enabled": true
        },
        "failOnQualityGateFailure": true,
        "owaspDependencyCheck": {
          "enabled": true,
          "additionalParams": "--disableNodeAudit --nodePackageSkipDevDependencies"
        }
      }
    },
    {
      "name": "taggingMinor",
      "enabled": true,
      "tagging": {
        "updateHelmChart": true,
        "versionIncrementPosition": "minor"
      },
      "branchNamePrefixes": [
        "master"
      ],
      "triggerType": [
        "GITEVENT"
      ]
    },
    {
      "name": "release",
      "triggerType": [
        "GITEVENT"
      ],
      "tasks": [
        {
          "name": "generate-apim-config",
          "taskRef": "esta-gradle-build-extra-large",
          "params": {
            "TASKS": ":apim-configuration:generateSpec",
            "ARTIFACTORY_SECRET": "esta-tekton-basicauth-docker",
            "BUILDER_JAVA_VERSION": "21",
            "BUILDER_KOTLIN_VERSION": "1.7",
            "BUILDER_NODE_VERSION": "20",
            "JDK_BUILDERIMAGE": "esta.docker.bin.sbb.ch/esta/esta-tekton-pipeline-java-builderimage:2.9.1",
            "SONAR_HOST_URL": "https://codequality.sbb.ch",
            "SONAR_LOGIN_SECRET": "esta-tekton-sonar-api-key"
          },
          "runAfter": "gradle-build",
          "runBefore": "gradle-sonarscan"
        },
        {
          "name": "atlas-start-deploy-dev-pipeline",
          "taskRef": "atlas-start-pipeline",
          "params": {
            "GIT_PROJECT": "KI_ATLAS",
            "GIT_REPOSITORY": "atlas-deploy-dev",
            "GIT_REVISION": "refs/heads/master",
            "PIPELINE_CONFIG_NAME": "continuous",
            "PIPELINE_PARAMETERS_JSON": "{\"VERSION_TO_DEPLOY\":\"${VERSION_TAG}\"}"
          },
          "runAfter": "gradle-deploy"
        },
        {
          "name": "atlas-start-deploy-test-pipeline",
          "taskRef": "atlas-start-pipeline",
          "params": {
            "GIT_PROJECT": "KI_ATLAS",
            "GIT_REPOSITORY": "atlas-deploy-test",
            "GIT_REVISION": "refs/heads/master",
            "PIPELINE_CONFIG_NAME": "continuous",
            "PIPELINE_PARAMETERS_JSON": "{\"VERSION_TO_DEPLOY\":\"${VERSION_TAG}\"}"
          },
          "runAfter": "gradle-deploy"
        }
      ],
      "tagging": {
        "versionIncrementPosition": "minor"
      },
      "versionTagEventPatterns": [
        "^(\\d+\\.)?(\\d+\\.)?(\\*|\\d+)$"
      ],
      "build": {
        "testcontainers": {
          "enabled": true
        },
        "deployArtifacts": true,
        "buildDockerImage": true,
        "additionalBuildParams": "--parallel",
        "sonarScan": {
          "releaseBranchName": "master",
          "enabled": true
        },
        "owaspDependencyCheck": {
          "enabled": true,
          "additionalParams": "--disableNodeAudit --nodePackageSkipDevDependencies"
        },
        "failOnQualityGateFailure": true
      }
    }
  ],
  "notifications": [
    {
      "type": "TEAMS",
      "enabled": true,
      "eventTypes": [
        "SUCCESS",
        "FAILURE",
        "ABORTED"
      ],
      "webhookSecretName": "esta-tekton-pipeline-env"
    }
  ]
}

