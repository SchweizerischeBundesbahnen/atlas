#!groovy
pipeline {

  agent {
    label 'java'
  }

  environment {
    CYPRESS_BASE_URL = 'https://timetable-field-number-frontend-test.apps.aws01t.sbb-aws-test.net'
    NO_COLOR = 1
  }

  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr:'5'))
    timeout(time: 10, unit: 'MINUTES')
    timestamps()
  }

  parameters {
    string( name: 'app_environment', defaultValue: 'test', description: 'Deployed application environment')
  }

  stages {
    stage('Build npm dependencies') {
      steps {
        sh 'npm ci'
      }
    }
    stage('Run Cypress E2E Tests') {
      steps {
        sh 'npm run cypress:run'
      }
    }
  }

  post {

    always {
      cleanWs()
      echo 'Archive cypress videos'
      archiveArtifacts 'cypress/videos/*.mp4'
      echo 'Archive cypress screenshots'
      archiveArtifacts 'cypress/screenshots/**/*'
    }

    success {
      echo 'Success...'
    }

  }
}
