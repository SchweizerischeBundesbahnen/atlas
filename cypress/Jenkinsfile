#!groovy
pipeline {

  agent {
    label 'java'
  }

  environment {
    CYPRESS_BASE_URL = 'https://timetable-field-number-frontend-test.apps.aws01t.sbb-aws-test.net'
    NO_COLOR = 1
  }

  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr:'5'))
    timeout(time: 10, unit: 'MINUTES')
    timestamps()
  }

  parameters {
    string( name: 'app_environment', defaultValue: 'test', description: 'Deployed application environment')
  }

  stages {
    stage('Build npm dependencies') {
      steps {
        sh 'npm ci'
      }
    }
    stage('Run Cypress E2E Tests') {
      steps {
        sh 'npm run cypress:run'
      }
    }
  }

  post {

    always {
      cleanWs()
      echo 'Archive cypress videos'
      archiveArtifacts 'cypress/videos/*.mp4'
      echo 'Archive cypress screenshots'
      archiveArtifacts 'cypress/screenshots/**/*'
    }

    success {
      echo 'Success...'
    }

    failure {
      office365ConnectorSend webhookUrl: "https://sbb.webhook.office.com/webhookb2/e262e9dc-5836-4c36-b3e5-0e827f2a2787@2cda5d11-f0ac-46b3-967d-af1b2e1bd01a/JenkinsCI/1d957b31eb2c46aeac8003d5a70e1926/8231c64b-bcb4-497e-93bf-0213ebdac9e4",
         message: 'Timetable Field Number Cypress E2E Tests',
         status: 'Error'
        }

  }
}
